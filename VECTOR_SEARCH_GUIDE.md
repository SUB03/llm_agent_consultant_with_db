# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –≤–µ–∫—Ç–æ—Ä–Ω–æ–º—É –ø–æ–∏—Å–∫—É

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –¢–µ–∫—Å—Ç–æ–≤—ã–π vs –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫

**–¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±):**
```python
# –ò—â–µ—Ç —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–ª–æ–≤
db.search_knowledge("–∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑")
# –ù–∞–π–¥–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –≤–æ–ø—Ä–æ—Å–µ –µ—Å—Ç—å —Å–ª–æ–≤–∞ "–æ—Ñ–æ—Ä–º–∏—Ç—å" –∏–ª–∏ "–∑–∞–∫–∞–∑"
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ –ø–æ–Ω–∏–º–∞–µ—Ç —Å–∏–Ω–æ–Ω–∏–º—ã ("–∫—É–ø–∏—Ç—å" ‚â† "–ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏")
- ‚ùå –ù–µ –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç ("–∑–∞–∫–∞–∑" –≤ —Ä–∞–∑–Ω—ã—Ö —Å–º—ã—Å–ª–∞—Ö)
- ‚ùå –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ (–Ω–æ–≤—ã–π —Å–ø–æ—Å–æ–±):**
```python
# –ü–æ–Ω–∏–º–∞–µ—Ç —Å–º—ã—Å–ª –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
db.search_knowledge("–∫–∞–∫ –∫—É–ø–∏—Ç—å —Ç–æ–≤–∞—Ä", use_vector=True)
# –ù–∞–π–¥–µ—Ç: "–∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", "–ø—Ä–æ—Ü–µ—Å—Å –ø–æ–∫—É–ø–∫–∏", "–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü–æ–Ω–∏–º–∞–µ—Ç —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –ø–æ—Ö–æ–∂–∏–µ –ø–æ —Å–º—ã—Å–ª—É —Å–ª–æ–≤–∞
- ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
- ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–∞–∂–µ –µ—Å–ª–∏ —Å–ª–æ–≤–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–∞—Ö

---

## –ö–∞–∫ —ç—Ç–æ —É—Å—Ç—Ä–æ–µ–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏

### –®–∞–≥ 1: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –≤–µ–∫—Ç–æ—Ä—ã

–ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ **—ç–º–±–µ–¥–¥–∏–Ω–≥** - –º–∞—Å—Å–∏–≤ –∏–∑ 1024 —á–∏—Å–µ–ª:

```
"–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?" ‚Üí [0.123, -0.456, 0.789, ..., 0.321]
                         1024 —á–∏—Å–ª–∞
```

–ü–æ—Ö–æ–∂–∏–µ –ø–æ —Å–º—ã—Å–ª—É –≤–æ–ø—Ä–æ—Å—ã –∏–º–µ—é—Ç –ø–æ—Ö–æ–∂–∏–µ –≤–µ–∫—Ç–æ—Ä—ã:
```
"–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?"     ‚Üí [0.1, 0.5, 0.3, ...]
"–ö–∞–∫ –∫—É–ø–∏—Ç—å —Ç–æ–≤–∞—Ä?"       ‚Üí [0.2, 0.4, 0.4, ...]  ‚Üê –±–ª–∏–∑–∫–æ
"–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–µ?"  ‚Üí [0.9, -0.8, 0.1, ...] ‚Üê –¥–∞–ª–µ–∫–æ
```

### –®–∞–≥ 2: –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤

PostgreSQL —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º **pgvector** —É–º–µ–µ—Ç –∏—Å–∫–∞—Ç—å –ø–æ—Ö–æ–∂–∏–µ –≤–µ–∫—Ç–æ—Ä—ã:

```sql
SELECT *, 
       1 - (embedding <=> query_vector) AS similarity
FROM knowledge_base
WHERE is_active = true
ORDER BY similarity DESC
LIMIT 5;
```

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ** - –º–µ—Ä–∞ –ø–æ—Ö–æ–∂–µ—Å—Ç–∏ –≤–µ–∫—Ç–æ—Ä–æ–≤.

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –≥–æ—Ç–æ–≤–∞!

–í Docker —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω pgvector:
```yaml
# docker-compose.yml
vector_db:
  image: pgvector/pgvector:pg16  # ‚úÖ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
```

### 2. –î–æ–±–∞–≤–∏—Ç—å API –∫–ª—é—á DeepSeek

–°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª:
```bash
DEEPSEEK_API_KEY=your-api-key-here
DATABASE_URL=postgresql://user:password@vector_db:5432/web_assistant
```

### 3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É knowledge_base

–¢–∞–±–ª–∏—Ü–∞ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å - –¥–æ–±–∞–≤–∏–ª–æ—Å—å –ø–æ–ª–µ `embedding`:

```python
# –í–∞–∂–Ω–æ! –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
from db.db import Database

db = Database()
db.drop_tables()  # –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã
db.create_tables()  # –°–æ–∑–¥–∞—Ç—å —Å –Ω–æ–≤—ã–º –ø–æ–ª–µ–º embedding
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ Docker:**
```bash
docker compose down -v
docker compose up -d
docker compose exec web_assistant python3 init_db.py
```

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ FAQ —ç–º–±–µ–¥–¥–∏–Ω–≥ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

```python
from db.db import Database
import os

os.environ['DEEPSEEK_API_KEY'] = 'your-api-key'
db = Database()

# –≠–º–±–µ–¥–¥–∏–Ω–≥ —Å–æ–∑–¥–∞—Å—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
faq_id = db.add_knowledge(
    question="–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?",
    answer="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä, –¥–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É, –æ—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑",
    category="–ü–æ–∫—É–ø–∫–∏"
)
# ‚úÖ –í–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ DeepSeek API
# ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç—Å—è embedding –∏–∑ 1024 —á–∏—Å–µ–ª
# ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–æ–ª–µ embedding
```

### –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

```python
# –ï—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
faq_id = db.add_knowledge(
    question="–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?",
    answer="...",
    auto_embed=False  # –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥
)
```

### –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫

```python
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
results = db.search_knowledge("–∫–∞–∫ –∫—É–ø–∏—Ç—å —Ç–æ–≤–∞—Ä")

# –ï—Å–ª–∏ API –∫–ª—é—á –µ—Å—Ç—å - –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
# –ï—Å–ª–∏ –Ω–µ—Ç - fallback –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫

for kb in results:
    print(f"Q: {kb.question}")
    print(f"A: {kb.answer}")
    print("---")
```

**–í—ã–≤–æ–¥:**
```
Q: –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?
A: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä, –¥–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É...
---
Q: –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–∫—É–ø–∫–∏ –Ω–∞ —Å–∞–π—Ç–µ
A: –ù–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ç–æ–≤–∞—Ä, –Ω–∞–∂–º–∏—Ç–µ "–ö—É–ø–∏—Ç—å"...
---
```

### –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫

```python
# –û—Ç–∫–ª—é—á–∏—Ç—å –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
results = db.search_knowledge("–∑–∞–∫–∞–∑", use_vector=False)
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –£–º–Ω—ã–π –ø–æ–∏—Å–∫ FAQ

```python
import os
from db.db import Database

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞
os.environ['DEEPSEEK_API_KEY'] = 'sk-xxxxx'
db = Database('postgresql://user:password@localhost:5434/web_assistant')

# –î–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ FAQ
faqs = [
    {
        'question': '–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?',
        'answer': '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä, –¥–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É',
        'category': '–ü–æ–∫—É–ø–∫–∏'
    },
    {
        'question': '–ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã?',
        'answer': '–ö–∞—Ä—Ç—ã Visa/MasterCard, PayPal, –Ω–∞–ª–∏—á–Ω—ã–µ',
        'category': '–û–ø–ª–∞—Ç–∞'
    },
    {
        'question': '–°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∞?',
        'answer': '–ü–æ –ú–æ—Å–∫–≤–µ 1-2 –¥–Ω—è, –ø–æ –†–æ—Å—Å–∏–∏ 3-7 –¥–Ω–µ–π',
        'category': '–î–æ—Å—Ç–∞–≤–∫–∞'
    }
]

for faq in faqs:
    db.add_knowledge(**faq)
    print(f"‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ: {faq['question']}")

# –ü–æ–∏—Å–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º–∏
queries = [
    "–∫–∞–∫ –∫—É–ø–∏—Ç—å",           # –Ω–∞–π–¥–µ—Ç "–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?"
    "—á–µ–º –º–æ–∂–Ω–æ –ø–ª–∞—Ç–∏—Ç—å",    # –Ω–∞–π–¥–µ—Ç "–ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã?"
    "–∫–æ–≥–¥–∞ –ø—Ä–∏–¥–µ—Ç –ø–æ—Å—ã–ª–∫–∞", # –Ω–∞–π–¥–µ—Ç "–°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∞?"
]

for query in queries:
    print(f"\nüîç –ü–æ–∏—Å–∫: '{query}'")
    results = db.search_knowledge(query, limit=1)
    if results:
        print(f"   –ù–∞–π–¥–µ–Ω–æ: {results[0].question}")
        print(f"   –û—Ç–≤–µ—Ç: {results[0].answer}")
```

**–í—ã–≤–æ–¥:**
```
‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ: –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?
‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ: –ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã?
‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ: –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∞?

üîç –ü–æ–∏—Å–∫: '–∫–∞–∫ –∫—É–ø–∏—Ç—å'
   –ù–∞–π–¥–µ–Ω–æ: –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?
   –û—Ç–≤–µ—Ç: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä, –¥–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É

üîç –ü–æ–∏—Å–∫: '—á–µ–º –º–æ–∂–Ω–æ –ø–ª–∞—Ç–∏—Ç—å'
   –ù–∞–π–¥–µ–Ω–æ: –ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã?
   –û—Ç–≤–µ—Ç: –ö–∞—Ä—Ç—ã Visa/MasterCard, PayPal, –Ω–∞–ª–∏—á–Ω—ã–µ

üîç –ü–æ–∏—Å–∫: '–∫–æ–≥–¥–∞ –ø—Ä–∏–¥–µ—Ç –ø–æ—Å—ã–ª–∫–∞'
   –ù–∞–π–¥–µ–Ω–æ: –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∞?
   –û—Ç–≤–µ—Ç: –ü–æ –ú–æ—Å–∫–≤–µ 1-2 –¥–Ω—è, –ø–æ –†–æ—Å—Å–∏–∏ 3-7 –¥–Ω–µ–π
```

### –ü—Ä–∏–º–µ—Ä 2: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∏ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

```python
# –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ - –∏—â–µ—Ç —Ç–æ—á–Ω—ã–µ —Å–ª–æ–≤–∞
print("=== –¢–ï–ö–°–¢–û–í–´–ô –ü–û–ò–°–ö ===")
results = db.search_knowledge("–∫—É–ø–∏—Ç—å", use_vector=False)
print(f"–ù–∞–π–¥–µ–Ω–æ: {len(results)} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
for r in results:
    print(f"  - {r.question}")

# –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ - –ø–æ–Ω–∏–º–∞–µ—Ç —Å–º—ã—Å–ª
print("\n=== –í–ï–ö–¢–û–†–ù–´–ô –ü–û–ò–°–ö ===")
results = db.search_knowledge("–∫—É–ø–∏—Ç—å", use_vector=True)
print(f"–ù–∞–π–¥–µ–Ω–æ: {len(results)} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
for r in results:
    print(f"  - {r.question}")
```

**–í—ã–≤–æ–¥:**
```
=== –¢–ï–ö–°–¢–û–í–´–ô –ü–û–ò–°–ö ===
–ù–∞–π–¥–µ–Ω–æ: 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
(—Å–ª–æ–≤–∞ "–∫—É–ø–∏—Ç—å" –Ω–µ—Ç –Ω–∏ –≤ –æ–¥–Ω–æ–º –≤–æ–ø—Ä–æ—Å–µ)

=== –í–ï–ö–¢–û–†–ù–´–ô –ü–û–ò–°–ö ===
–ù–∞–π–¥–µ–Ω–æ: 3 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  - –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?
  - –ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã?
  - –ú–æ–∂–Ω–æ –ª–∏ –≤–µ—Ä–Ω—É—Ç—å —Ç–æ–≤–∞—Ä?
```

### –ü—Ä–∏–º–µ—Ä 3: REST API endpoint —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –ø–æ–∏—Å–∫–æ–º

```python
from flask import Flask, request, jsonify
from db.db import Database
import os

app = Flask(__name__)
os.environ['DEEPSEEK_API_KEY'] = 'sk-xxxxx'
db = Database('postgresql://user:password@localhost:5434/web_assistant')

@app.route('/api/search', methods=['POST'])
def search_faq():
    """–ü–æ–∏—Å–∫ –≤ FAQ"""
    data = request.json
    query = data.get('query', '')
    category = data.get('category')
    limit = data.get('limit', 5)
    
    # –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
    results = db.search_knowledge(query, category=category, limit=limit)
    
    return jsonify({
        'query': query,
        'count': len(results),
        'results': [
            {
                'id': r.id,
                'question': r.question,
                'answer': r.answer,
                'category': r.category
            } for r in results
        ]
    })

if __name__ == '__main__':
    app.run(debug=True, port=8000)
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
curl -X POST http://localhost:8000/api/search \
  -H "Content-Type: application/json" \
  -d '{"query": "–∫–∞–∫ –∫—É–ø–∏—Ç—å —Ç–æ–≤–∞—Ä", "limit": 3}'
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "query": "–∫–∞–∫ –∫—É–ø–∏—Ç—å —Ç–æ–≤–∞—Ä",
  "count": 3,
  "results": [
    {
      "id": 1,
      "question": "–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?",
      "answer": "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä, –¥–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É...",
      "category": "–ü–æ–∫—É–ø–∫–∏"
    },
    {
      "id": 2,
      "question": "–ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã?",
      "answer": "–ö–∞—Ä—Ç—ã Visa/MasterCard, PayPal...",
      "category": "–û–ø–ª–∞—Ç–∞"
    },
    {
      "id": 5,
      "question": "–ú–æ–∂–Ω–æ –ª–∏ –∑–∞–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤?",
      "answer": "–î–∞, –¥–æ–±–∞–≤—å—Ç–µ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É...",
      "category": "–ü–æ–∫—É–ø–∫–∏"
    }
  ]
}
```

---

## –°—Ç–æ–∏–º–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

DeepSeek Embeddings API –æ—á–µ–Ω—å –¥–µ—à–µ–≤—ã–π:

- **–ú–æ–¥–µ–ª—å:** `deepseek-chat` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤)
- **–¶–µ–Ω–∞:** ~$0.0001 –∑–∞ 1K —Ç–æ–∫–µ–Ω–æ–≤ (~750 —Å–ª–æ–≤)
- **–†–∞–∑–º–µ—Ä –≤–µ–∫—Ç–æ—Ä–∞:** 1024 –∏–∑–º–µ—Ä–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞:**
```
100 FAQ –≤–æ–ø—Ä–æ—Å–æ–≤ (–≤ —Å—Ä–µ–¥–Ω–µ–º –ø–æ 10 —Å–ª–æ–≤) = 1000 —Å–ª–æ–≤
1000 —Å–ª–æ–≤ ‚âà 1.3K —Ç–æ–∫–µ–Ω–æ–≤
–°—Ç–æ–∏–º–æ—Å—Ç—å: 1.3 √ó $0.0001 = $0.00013 (–º–µ–Ω—å—à–µ —Ü–µ–Ω—Ç–∞!)
```

–ü–æ–∏—Å–∫ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç API –≤—ã–∑–æ–≤–æ–≤ - –æ–Ω –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–æ–∫–∞–ª—å–Ω–æ –≤ PostgreSQL!

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç fallback

–ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω:

```python
results = db.search_knowledge("–∑–∞–∫–∞–∑")

# 1. –ü–æ–ø—ã—Ç–∫–∞ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
#    ‚Üì –ï—Å—Ç—å API –∫–ª—é—á?
#    ‚îú‚îÄ –î–∞ ‚Üí DeepSeek API ‚Üí –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
#    ‚îî‚îÄ –ù–µ—Ç ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É 2
#
# 2. –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ (ILIKE)
#    ‚Üì SQL: WHERE question ILIKE '%–∑–∞–∫–∞–∑%'
#    ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```

**–ö–æ–¥ fallback:**
```python
def search_knowledge(self, query, category=None, limit=5, use_vector=True):
    session = self.get_session()
    try:
        # –ü–æ–ø—ã—Ç–∫–∞ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
        if use_vector and self.deepseek_api_key:
            query_embedding = self.get_embedding(query)
            if query_embedding:
                return self.vector_search(query_embedding, category, limit, session)
        
        # Fallback –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
        q = session.query(KnowledgeBase).filter(KnowledgeBase.is_active == True)
        # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
```

---

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫

‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –∫–æ–≥–¥–∞:**
- FAQ –±–∞–∑–∞ –±–æ–ª—å—à–∞—è (>100 –≤–æ–ø—Ä–æ—Å–æ–≤)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–¥–∞—é—Ç –≤–æ–ø—Ä–æ—Å—ã –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ
- –ù—É–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –†–∞–±–æ—Ç–∞–µ—Ç–µ —Å —Ä–∞–∑–Ω—ã–º–∏ —è–∑—ã–∫–∞–º–∏

‚ùå **–¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω –∫–æ–≥–¥–∞:**
- FAQ –º–∞–ª–µ–Ω—å–∫–∞—è (<20 –≤–æ–ø—Ä–æ—Å–æ–≤)
- –í–æ–ø—Ä–æ—Å—ã –æ—á–µ–Ω—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ (SKU, –∞—Ä—Ç–∏–∫—É–ª—ã)
- –ù—É–∂–µ–Ω —Ç–æ—á–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

```python
# –°–æ–∑–¥–∞–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ batch'–∞–º–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
faqs = [...]  # –ú–Ω–æ–≥–æ FAQ

for i in range(0, len(faqs), 10):  # –ü–æ 10 –∑–∞ —Ä–∞–∑
    batch = faqs[i:i+10]
    for faq in batch:
        db.add_knowledge(**faq)
    time.sleep(1)  # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏
```

### 3. –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```sql
-- –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (—É—Å–∫–æ—Ä—è–µ—Ç –ø–æ–∏—Å–∫)
CREATE INDEX ON knowledge_base 
USING ivfflat (embedding vector_cosine_ops) 
WITH (lists = 100);
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞

```python
# –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
def search_with_logging(query):
    results = db.search_knowledge(query)
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫—É
    db.set_context(
        f'search_log_{datetime.now().isoformat()}',
        json.dumps({
            'query': query,
            'results_count': len(results),
            'top_result': results[0].question if results else None
        }),
        category='analytics'
    )
    
    return results
```

---

## Troubleshooting

### –û—à–∏–±–∫–∞: "CREATE EXTENSION IF NOT EXISTS vector" –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

```python
# –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é –≤ PostgreSQL
docker compose exec vector_db psql -U user -d web_assistant

# –í psql:
CREATE EXTENSION IF NOT EXISTS vector;
\q
```

### –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. API –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: `echo $DEEPSEEK_API_KEY`
2. –î–æ—Å—Ç—É–ø –∫ API: `curl https://api.deepseek.com/v1/embeddings`
3. –ë–∞–ª–∞–Ω—Å –∞–∫–∫–∞—É–Ω—Ç–∞ DeepSeek

### –ü–æ–∏—Å–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

```python
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏
def vector_search_with_threshold(query_embedding, threshold=0.7):
    results = db.vector_search(query_embedding)
    # –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Å—Ö–æ–∂–µ—Å—Ç–∏ (0-1, –≥–¥–µ 1 = –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ)
    return [r for r in results if r[1] >= threshold]
```

---

## –î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ

1. **–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫** - –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ + —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ:
   ```python
   vector_results = db.search_knowledge(query, use_vector=True)
   text_results = db.search_knowledge(query, use_vector=False)
   # –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞—Ç—å
   ```

2. **Re-ranking** - –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é LLM

3. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤** - –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

4. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ vs —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞

---

## –°–º. —Ç–∞–∫–∂–µ

- [DATABASE_GUIDE.md](DATABASE_GUIDE.md) - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ë–î
- [DEEPSEEK_GUIDE.md](DEEPSEEK_GUIDE.md) - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DeepSeek
- [PGVECTOR_GUIDE.md](PGVECTOR_GUIDE.md) - –ü–æ–¥—Ä–æ–±–Ω–æ –æ pgvector
