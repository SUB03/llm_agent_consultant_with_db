# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤–µ–±-–ø–æ–º–æ—â–Ω–∏–∫–∞

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ç–∞–±–ª–∏—Ü)
3. [–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è](#–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
4. [–†–∞–±–æ—Ç–∞ —Å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏](#—Ä–∞–±–æ—Ç–∞-—Å-–ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏)
5. [–†–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏](#—Ä–∞–±–æ—Ç–∞-—Å-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
6. [–†–∞–±–æ—Ç–∞ —Å —Å–µ—Å—Å–∏—è–º–∏](#—Ä–∞–±–æ—Ç–∞-—Å-—Å–µ—Å—Å–∏—è–º–∏)
7. [–†–∞–±–æ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏](#—Ä–∞–±–æ—Ç–∞-—Å-—Å–æ–æ–±—â–µ–Ω–∏—è–º–∏)
8. [–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (FAQ)](#–±–∞–∑–∞-–∑–Ω–∞–Ω–∏–π-faq)
9. [–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∏-–≤–∏–¥–∂–µ—Ç–∞)
10. [–ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–≥–µ–Ω—Ç–∞](#–∫–æ–Ω—Ç–µ–∫—Å—Ç-–∞–≥–µ–Ω—Ç–∞)
11. [–ü–æ–ª–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã](#–ø–æ–ª–Ω—ã–µ-–ø—Ä–∏–º–µ—Ä—ã)

---

## –û–±–∑–æ—Ä

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–µ–±-–ø–æ–º–æ—â–Ω–∏–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ PostgreSQL —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SQLAlchemy ORM. –û–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- –ê–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤
- –ë–∞–∑—É –∑–Ω–∞–Ω–∏–π –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ —á–∞—Ç–∞
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ AI –∞–≥–µ–Ω—Ç–∞

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

### 1. **visitors** - –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏

–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è—Ö —Å–∞–π—Ç–∞ –¥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | Integer | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| visitor_id | String(100) | UUID –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) |
| ip_address | String(50) | IP-–∞–¥—Ä–µ—Å |
| user_agent | String(500) | User-Agent –±—Ä–∞—É–∑–µ—Ä–∞ |
| device_type | String(50) | desktop, mobile, tablet |
| browser | String(100) | Chrome, Firefox, Safari –∏ —Ç.–¥. |
| first_visit | DateTime | –ü–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç |
| last_visit | DateTime | –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç |

**–°–≤—è–∑–∏:**
- `sessions` ‚Üí –û–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º —Å —Ç–∞–±–ª–∏—Ü–µ–π `sessions`

---

### 2. **users** - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | Integer | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| username | String(100) | –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ) |
| email | String(255) | Email (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) |
| phone | String(50) | –¢–µ–ª–µ—Ñ–æ–Ω |
| created_at | DateTime | –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ |

**–°–≤—è–∑–∏:**
- `sessions` ‚Üí –û–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º —Å —Ç–∞–±–ª–∏—Ü–µ–π `sessions`

---

### 3. **sessions** - –°–µ—Å—Å–∏–∏ —á–∞—Ç–æ–≤

–ö–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω –¥–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | Integer | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| visitor_id | Integer | FK –Ω–∞ visitors (–¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö) |
| user_id | Integer | FK –Ω–∞ users (–¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö) |
| session_uuid | String(100) | UUID —Å–µ—Å—Å–∏–∏ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ API |
| title | String(255) | –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ |
| page_url | String(500) | URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –≥–¥–µ –Ω–∞—á–∞–ª—Å—è —á–∞—Ç |
| created_at | DateTime | –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ |
| updated_at | DateTime | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |
| ended_at | DateTime | –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è |
| is_active | Boolean | –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —Å–µ—Å—Å–∏—è |
| satisfaction_rating | Integer | –û—Ü–µ–Ω–∫–∞ 1-5 |

**–°–≤—è–∑–∏:**
- `visitor` ‚Üí –ú–Ω–æ–≥–∏–µ-–∫-–æ–¥–Ω–æ–º—É —Å `visitors`
- `user` ‚Üí –ú–Ω–æ–≥–∏–µ-–∫-–æ–¥–Ω–æ–º—É —Å `users`
- `messages` ‚Üí –û–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º —Å `messages`

---

### 4. **messages** - –°–æ–æ–±—â–µ–Ω–∏—è

–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –¥–∏–∞–ª–æ–≥–µ.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | Integer | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| session_id | Integer | FK –Ω–∞ sessions |
| role | String(50) | user, assistant, system |
| content | Text | –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è |
| timestamp | DateTime | –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ |
| tokens_used | Integer | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏) |

**–°–≤—è–∑–∏:**
- `session` ‚Üí –ú–Ω–æ–≥–∏–µ-–∫-–æ–¥–Ω–æ–º—É —Å `sessions`

---

### 5. **knowledge_base** - –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (FAQ)

–í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | Integer | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| question | Text | –í–æ–ø—Ä–æ—Å |
| answer | Text | –û—Ç–≤–µ—Ç |
| category | String(100) | –ö–∞—Ç–µ–≥–æ—Ä–∏—è (–î–æ—Å—Ç–∞–≤–∫–∞, –û–ø–ª–∞—Ç–∞ –∏ —Ç.–¥.) |
| keywords | Text | –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ |
| **embedding** | **Vector(1024)** | **–í–µ–∫—Ç–æ—Ä–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ (–¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞)** |
| priority | Integer | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è |
| is_active | Boolean | –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ –∑–∞–ø–∏—Å—å |
| views_count | Integer | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ |
| helpful_count | Integer | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫ |
| created_at | DateTime | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_at | DateTime | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

> **üí° –ü–æ–ª–µ `embedding`** —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ (1024 —á–∏—Å–ª–∞ –æ—Ç DeepSeek API).  
> –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ - –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ—Ö–æ–∂–∏–µ –ø–æ —Å–º—ã—Å–ª—É –≤–æ–ø—Ä–æ—Å—ã.  
> –ü–æ–¥—Ä–æ–±–Ω–µ–µ: [VECTOR_SEARCH_GUIDE.md](VECTOR_SEARCH_GUIDE.md)

---

### 6. **chat_widget** - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è —á–∞—Ç-–≤–∏–¥–∂–µ—Ç–∞.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | Integer | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| name | String(100) | –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ) |
| welcome_message | Text | –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ |
| placeholder_text | String(255) | Placeholder –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ |
| bot_name | String(100) | –ò–º—è –±–æ—Ç–∞ |
| bot_avatar_url | String(500) | URL –∞–≤–∞—Ç–∞—Ä–∞ |
| primary_color | String(20) | –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç (#hex) |
| position | String(20) | bottom-right, bottom-left –∏ —Ç.–¥. |
| auto_open_delay | Integer | –ó–∞–¥–µ—Ä–∂–∫–∞ –∞–≤—Ç–æ–æ—Ç–∫—Ä—ã—Ç–∏—è (—Å–µ–∫) |
| offline_message | Text | –°–æ–æ–±—â–µ–Ω–∏–µ –≤ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è |
| is_active | Boolean | –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –≤–∏–¥–∂–µ—Ç |
| business_hours | JSON | –†–∞–±–æ—á–∏–µ —á–∞—Å—ã |
| created_at | DateTime | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_at | DateTime | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

---

### 7. **context** - –ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–≥–µ–Ω—Ç–∞

–ö–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ AI.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | Integer | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| key | String(255) | –ö–ª—é—á (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) |
| value | Text | –ó–Ω–∞—á–µ–Ω–∏–µ |
| category | String(100) | –ö–∞—Ç–µ–≥–æ—Ä–∏—è |
| created_at | DateTime | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_at | DateTime | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

---

## –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```python
from db.db import Database

# SQLite (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
db = Database('sqlite:///web_assistant.db')

# PostgreSQL (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
db = Database('postgresql://user:password@localhost:5432/web_assistant')

# –ß–µ—Ä–µ–∑ Docker
db = Database('postgresql://user:password@vector_db:5432/web_assistant')

# –ß–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
import os
db_url = os.getenv('DATABASE_URL')
db = Database(db_url)
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü

```python
# –°–æ–∑–¥–∞—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
db.create_tables()

# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
db.drop_tables()
```

---

## –†–∞–±–æ—Ç–∞ —Å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏

### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è

```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è visitor_id
visitor_id = db.create_or_get_visitor(
    ip_address="192.168.1.1",
    user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64)...",
    device_type="desktop",
    browser="Chrome"
)
print(f"–°–æ–∑–¥–∞–Ω –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—å: {visitor_id}")
```

**–í—ã–≤–æ–¥:**
```
–°–æ–∑–¥–∞–Ω –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—å: 1
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è

```python
# –ü–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É UUID
visitor_uuid = "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
visitor_id = db.create_or_get_visitor(
    visitor_id=visitor_uuid,
    ip_address="192.168.1.1"
)

# –ï—Å–ª–∏ visitor_uuid —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –æ–±–Ω–æ–≤–∏—Ç last_visit
# –ï—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤–æ–≥–æ
```

### –ü—Ä–∏–º–µ—Ä: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è —Å cookies

```python
from flask import request, session as flask_session

def track_visitor():
    # –ü–æ–ª—É—á–∏—Ç—å UUID –∏–∑ cookies –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
    visitor_uuid = flask_session.get('visitor_id')
    
    visitor_id = db.create_or_get_visitor(
        visitor_id=visitor_uuid,
        ip_address=request.remote_addr,
        user_agent=request.headers.get('User-Agent'),
        device_type=get_device_type(request),
        browser=get_browser_name(request)
    )
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å UUID –≤ cookies –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –≤–∏–∑–∏—Ç–æ–≤
    if not visitor_uuid:
        # –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π UUID –∏–∑ –ë–î
        flask_session['visitor_id'] = visitor_uuid
    
    return visitor_id
```

---

## –†–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
# –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
user_id = db.create_user("john_doe")

# –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
user_id = db.create_user(
    username="john_doe",
    email="john@example.com",
    phone="+79001234567"
)
print(f"–°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}")
```

**–í—ã–≤–æ–¥:**
```
–°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: 1
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
user = db.get_user(user_id=1)

if user:
    print(f"–ò–º—è: {user.username}")
    print(f"Email: {user.email}")
    print(f"–¢–µ–ª–µ—Ñ–æ–Ω: {user.phone}")
    print(f"–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: {user.created_at}")
```

**–í—ã–≤–æ–¥:**
```
–ò–º—è: john_doe
Email: john@example.com
–¢–µ–ª–µ—Ñ–æ–Ω: +79001234567
–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: 2025-12-27 18:30:45
```

### –ü—Ä–∏–º–µ—Ä: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
def register_user(username, email, phone):
    try:
        user_id = db.create_user(username, email, phone)
        return {"success": True, "user_id": user_id}
    except Exception as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥—É–±–ª–∏–∫–∞—Ç email)
        return {"success": False, "error": str(e)}

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
result = register_user("alice", "alice@example.com", "+79991234567")
if result['success']:
    print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω —Å ID: {result['user_id']}")
```

---

## –†–∞–±–æ—Ç–∞ —Å —Å–µ—Å—Å–∏—è–º–∏

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è

```python
# –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
session_id, session_uuid = db.create_session(
    visitor_id=1,
    page_url="https://example.com/shop/products"
)

print(f"Session ID: {session_id}")
print(f"Session UUID: {session_uuid}")
```

**–í—ã–≤–æ–¥:**
```
Session ID: 1
Session UUID: 7a8b9c0d-1e2f-3g4h-5i6j-7k8l9m0n1o2p
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
session_id, session_uuid = db.create_session(
    user_id=1,
    title="–í–æ–ø—Ä–æ—Å—ã –ø–æ –∑–∞–∫–∞–∑—É #12345",
    page_url="https://example.com/order/12345"
)
```

### –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏

```python
# –ë–µ–∑ –æ—Ü–µ–Ω–∫–∏
db.end_session(session_id=1)

# –° –æ—Ü–µ–Ω–∫–æ–π
db.end_session(session_id=1, satisfaction_rating=5)
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å–µ—Å—Å–∏–∏

```python
messages = db.get_session_messages(session_id=1)

for msg in messages:
    print(f"[{msg.timestamp}] {msg.role}: {msg.content}")
```

**–í—ã–≤–æ–¥:**
```
[2025-12-27 18:35:12] assistant: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?
[2025-12-27 18:35:45] user: –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?
[2025-12-27 18:35:50] assistant: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä, –¥–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É...
```

### –ü—Ä–∏–º–µ—Ä: –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å–µ—Å—Å–∏–∏

```python
def start_chat(visitor_id, page_url):
    """–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç"""
    session_id, session_uuid = db.create_session(
        visitor_id=visitor_id,
        page_url=page_url
    )
    
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    widget = db.get_widget_settings('default')
    db.add_message(
        session_id=session_id,
        role='assistant',
        content=widget.welcome_message if widget else "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!"
    )
    
    return session_uuid

def end_chat(session_id, rating=None):
    """–ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç"""
    db.end_session(session_id, satisfaction_rating=rating)
    
    # –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    messages = db.get_session_messages(session_id)
    user_messages = [m for m in messages if m.role == 'user']
    
    return {
        'total_messages': len(messages),
        'user_messages': len(user_messages),
        'rating': rating
    }
```

---

## –†–∞–±–æ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

```python
# –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
msg_id = db.add_message(
    session_id=1,
    role='user',
    content='–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?'
)

# –°–æ–æ–±—â–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
msg_id = db.add_message(
    session_id=1,
    role='assistant',
    content='–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä, –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É"...'
)

# –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
msg_id = db.add_message(
    session_id=1,
    role='system',
    content='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—à–µ–ª –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã'
)

# –° —É—á–µ—Ç–æ–º —Ç–æ–∫–µ–Ω–æ–≤ (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
msg_id = db.add_message(
    session_id=1,
    role='assistant',
    content='–û—Ç–≤–µ—Ç –æ—Ç AI...',
    tokens_used=150
)
```

### –ü—Ä–∏–º–µ—Ä: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
def process_message(session_id, user_message):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    db.add_message(session_id, 'user', user_message)
    
    # –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
    kb_results = db.search_knowledge(user_message, limit=1)
    
    if kb_results and kb_results[0]:
        # –ù–∞–π–¥–µ–Ω –≥–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
        answer = kb_results[0].answer
        db.add_message(session_id, 'assistant', answer)
        return {'answer': answer, 'source': 'knowledge_base'}
    else:
        # –ü–µ—Ä–µ–¥–∞—Ç—å –≤ AI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
        # ... –≤—ã–∑–æ–≤ AI API ...
        ai_answer = "–û—Ç–≤–µ—Ç –æ—Ç AI..."
        db.add_message(session_id, 'assistant', ai_answer, tokens_used=120)
        return {'answer': ai_answer, 'source': 'ai'}
```

---

## –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (FAQ)

> **üî• –í–ê–ñ–ù–û:** –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫** –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤!  
> –°–º. [VECTOR_SEARCH_GUIDE.md](VECTOR_SEARCH_GUIDE.md) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ FAQ

```python
# –ü—Ä–æ—Å—Ç–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ (—ç–º–±–µ–¥–¥–∏–Ω–≥ —Å–æ–∑–¥–∞—Å—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
faq_id = db.add_knowledge(
    question="–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?",
    answer="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä, –Ω–∞–∂–º–∏—Ç–µ '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É', –æ—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑"
)
# ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è embedding —á–µ—Ä–µ–∑ DeepSeek API

# –° –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
faq_id = db.add_knowledge(
    question="–ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã?",
    answer="–ú—ã –ø—Ä–∏–Ω–∏–º–∞–µ–º –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã Visa/MasterCard, PayPal, –Ω–∞–ª–∏—á–Ω—ã–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏",
    category="–û–ø–ª–∞—Ç–∞",
    keywords="–æ–ø–ª–∞—Ç–∞, –∫–∞—Ä—Ç–∞, –¥–µ–Ω—å–≥–∏, paypal, visa, mastercard"
)

# –ë–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–∞
faq_id = db.add_knowledge(
    question="–í–æ–ø—Ä–æ—Å",
    answer="–û—Ç–≤–µ—Ç",
    auto_embed=False  # –û—Ç–∫–ª—é—á–∏—Ç—å DeepSeek API
)
```

### –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π

–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫** –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–º—ã—Å–ª–∞ –≤–æ–ø—Ä–æ—Å–æ–≤:

```python
# –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –µ—Å—Ç—å DEEPSEEK_API_KEY)
results = db.search_knowledge("–¥–æ—Å—Ç–∞–≤–∫–∞")

# –ü–æ–Ω–∏–º–∞–µ—Ç —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç:
# "–¥–æ—Å—Ç–∞–≤–∫–∞" –Ω–∞–π–¥–µ—Ç: "–∫–æ–≥–¥–∞ –ø—Ä–∏–¥–µ—Ç", "—Å–∫–æ–ª—å–∫–æ –∂–¥–∞—Ç—å", "–æ—Ç–ø—Ä–∞–≤–∫–∞"

for kb in results:
    print(f"Q: {kb.question}")
    print(f"A: {kb.answer}")
    print(f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {kb.category}")
    print("---")
```

**–í—ã–≤–æ–¥:**
```
Q: –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∞?
A: –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –ú–æ—Å–∫–≤–µ - 1-2 –¥–Ω—è, –ø–æ –†–æ—Å—Å–∏–∏ - 3-7 –¥–Ω–µ–π
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: –î–æ—Å—Ç–∞–≤–∫–∞
---
Q: –ö–æ–≥–¥–∞ –ø—Ä–∏–¥–µ—Ç –º–æ–π –∑–∞–∫–∞–∑?
A: –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º—ã –ø—Ä–∏—à–ª–µ–º —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: –î–æ—Å—Ç–∞–≤–∫–∞
---
```

**–¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω —Ç–æ—á–Ω—ã–π –ø–æ–∏—Å–∫):**
```python
results = db.search_knowledge("–¥–æ—Å—Ç–∞–≤–∫–∞", use_vector=False)
```

### –ü–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

```python
# –¢–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ–ø–ª–∞—Ç–µ
results = db.search_knowledge("–∫–∞—Ä—Ç–∞", category="–û–ø–ª–∞—Ç–∞", limit=3)
```

### –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ FAQ

```python
faq_data = [
    {
        'question': '–ö–∞–∫ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –∑–∞–∫–∞–∑?',
        'answer': '–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä –Ω–∞ email',
        'category': '–î–æ—Å—Ç–∞–≤–∫–∞',
        'keywords': '—Ç—Ä–µ–∫, –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –≥–¥–µ –∑–∞–∫–∞–∑'
    },
    {
        'question': '–ú–æ–∂–Ω–æ –ª–∏ –≤–µ—Ä–Ω—É—Ç—å —Ç–æ–≤–∞—Ä?',
        'answer': '–î–∞, –≤–æ–∑–≤—Ä–∞—Ç –≤–æ–∑–º–æ–∂–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π',
        'category': '–í–æ–∑–≤—Ä–∞—Ç—ã',
        'keywords': '–≤–æ–∑–≤—Ä–∞—Ç, –≤–µ—Ä–Ω—É—Ç—å, –æ–±–º–µ–Ω'
    },
    {
        'question': '–ï—Å—Ç—å –ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∞ –≤ —Ä–µ–≥–∏–æ–Ω—ã?',
        'answer': '–î–∞, –¥–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏',
        'category': '–î–æ—Å—Ç–∞–≤–∫–∞',
        'keywords': '—Ä–µ–≥–∏–æ–Ω—ã, —Ä–æ—Å—Å–∏—è, –¥–æ—Å—Ç–∞–≤–∫–∞'
    }
]

for faq in faq_data:
    db.add_knowledge(**faq)

print(f"–î–æ–±–∞–≤–ª–µ–Ω–æ {len(faq_data)} FAQ")
```

### –ü—Ä–∏–º–µ—Ä: –£–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å fallback

```python
def smart_search(query):
    """–£–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏"""
    
    # –ü–æ–ø—ã—Ç–∫–∞ 1: –¢–æ—á–Ω—ã–π –ø–æ–∏—Å–∫
    results = db.search_knowledge(query, limit=3)
    if results:
        return results
    
    # –ü–æ–ø—ã—Ç–∫–∞ 2: –ü–æ–∏—Å–∫ –ø–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–ª–æ–≤–∞–º
    words = query.split()
    for word in words:
        if len(word) > 3:  # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞
            results = db.search_knowledge(word, limit=3)
            if results:
                return results
    
    return None

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
results = smart_search("—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –¥–æ—Å—Ç–∞–≤–∫–∞ –∫—É—Ä—å–µ—Ä–æ–º")
```

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞

### –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫

```python
widget = db.get_widget_settings('default')

if widget:
    print(f"–ò–º—è –±–æ—Ç–∞: {widget.bot_name}")
    print(f"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ: {widget.welcome_message}")
    print(f"–¶–≤–µ—Ç: {widget.primary_color}")
    print(f"–ü–æ–∑–∏—Ü–∏—è: {widget.position}")
```

**–í—ã–≤–æ–¥:**
```
–ò–º—è –±–æ—Ç–∞: –ü–æ–º–æ—â–Ω–∏–∫
–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?
–¶–≤–µ—Ç: #4CAF50
–ü–æ–∑–∏—Ü–∏—è: bottom-right
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫

```python
# –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
db.update_widget_settings(
    'default',
    bot_name="AI –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç",
    primary_color="#2196F3"
)

# –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
db.update_widget_settings(
    'default',
    welcome_message="–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –ö–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å?",
    placeholder_text="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å...",
    bot_name="–£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫",
    bot_avatar_url="https://example.com/avatar.png",
    primary_color="#4CAF50",
    position="bottom-right",
    auto_open_delay=10,
    offline_message="–ú—ã —Å–µ–π—á–∞—Å offline. –û—Å—Ç–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!",
    is_active=True,
    business_hours={
        "monday": {"start": "09:00", "end": "18:00"},
        "tuesday": {"start": "09:00", "end": "18:00"},
        "wednesday": {"start": "09:00", "end": "18:00"},
        "thursday": {"start": "09:00", "end": "18:00"},
        "friday": {"start": "09:00", "end": "18:00"}
    }
)
```

### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –≤–∏–¥–∂–µ—Ç–∞

```python
# –ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è –ø—Ä–æ–¥–∞–∂
db.update_widget_settings(
    'sales',
    bot_name="–ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–¥–∞–∂",
    welcome_message="–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü–æ–º–æ–≥—É –≤—ã–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä!",
    primary_color="#FF5722"
)

# –ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
db.update_widget_settings(
    'support',
    bot_name="–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞",
    welcome_message="–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É",
    primary_color="#607D8B"
)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
sales_widget = db.get_widget_settings('sales')
support_widget = db.get_widget_settings('support')
```

---

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–≥–µ–Ω—Ç–∞

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```python
# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
db.set_context(
    key='system_prompt',
    value='–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.',
    category='system'
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI
db.set_context(
    key='ai_model',
    value='deepseek-chat',
    category='config'
)

db.set_context(
    key='ai_temperature',
    value='0.7',
    category='config'
)

# –ö–∞—Å—Ç–æ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
db.set_context(
    key='shop_name',
    value='–ú–æ–π –ú–∞–≥–∞–∑–∏–Ω',
    category='branding'
)
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```python
system_prompt = db.get_context('system_prompt')
model = db.get_context('ai_model')
temperature = db.get_context('ai_temperature')
shop_name = db.get_context('shop_name')

print(f"–ü—Ä–æ–º–ø—Ç: {system_prompt}")
print(f"–ú–æ–¥–µ–ª—å: {model}")
print(f"Temperature: {temperature}")
print(f"–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞: {shop_name}")
```

**–í—ã–≤–æ–¥:**
```
–ü—Ä–æ–º–ø—Ç: –¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞...
–ú–æ–¥–µ–ª—å: deepseek-chat
Temperature: 0.7
–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞: –ú–æ–π –ú–∞–≥–∞–∑–∏–Ω
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```python
# –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—ã–∑–æ–≤–µ set_context - –∑–Ω–∞—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–∏—Ç—Å—è
db.set_context('ai_temperature', '0.5', 'config')
```

---

## –ü–æ–ª–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

### –ü—Ä–∏–º–µ—Ä 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è

```python
from flask import Flask, request, jsonify
import uuid

app = Flask(__name__)
db = Database('postgresql://user:password@localhost:5432/web_assistant')

@app.route('/api/chat/start', methods=['POST'])
def start_chat():
    """–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç"""
    data = request.json
    
    # –°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    visitor_id = db.create_or_get_visitor(
        visitor_id=data.get('visitor_id'),  # –û—Ç –∫–ª–∏–µ–Ω—Ç–∞
        ip_address=request.remote_addr,
        user_agent=request.headers.get('User-Agent'),
        device_type=data.get('device_type'),
        browser=data.get('browser')
    )
    
    # –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é
    session_id, session_uuid = db.create_session(
        visitor_id=visitor_id,
        page_url=data.get('page_url')
    )
    
    # –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    widget = db.get_widget_settings('default')
    welcome_msg = widget.welcome_message if widget else "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!"
    
    # –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    db.add_message(session_id, 'assistant', welcome_msg)
    
    return jsonify({
        'session_uuid': session_uuid,
        'welcome_message': welcome_msg
    })

if __name__ == '__main__':
    app.run(debug=True, port=8000)
```

### –ü—Ä–∏–º–µ—Ä 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–∏—Å–∫–æ–º –≤ FAQ

```python
@app.route('/api/chat/message', methods=['POST'])
def process_message():
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    data = request.json
    session_uuid = data.get('session_uuid')
    user_message = data.get('message')
    
    # –ù–∞–π—Ç–∏ —Å–µ—Å—Å–∏—é –ø–æ UUID
    from db.db import Session as DBSession
    session_obj = db.get_session()
    chat_session = session_obj.query(DBSession).filter(
        DBSession.session_uuid == session_uuid
    ).first()
    session_obj.close()
    
    if not chat_session:
        return jsonify({'error': 'Session not found'}), 404
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    db.add_message(chat_session.id, 'user', user_message)
    
    # –ü–æ–∏—Å–∫ –≤ FAQ
    kb_results = db.search_knowledge(user_message, limit=1)
    
    if kb_results and len(kb_results) > 0:
        # –ù–∞–π–¥–µ–Ω –≥–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
        answer = kb_results[0].answer
        confidence = 'high'
    else:
        # –ù—É–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ AI
        answer = "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –Ω–∞—à–µ–ª —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –î–∞–≤–∞–π—Ç–µ —Å–≤—è–∂–µ–º –≤–∞—Å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º."
        confidence = 'low'
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç
    db.add_message(chat_session.id, 'assistant', answer)
    
    return jsonify({
        'answer': answer,
        'confidence': confidence
    })
```

### –ü—Ä–∏–º–µ—Ä 3: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏

```python
def get_session_analytics(session_id):
    """–ü–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ —Å–µ—Å—Å–∏–∏"""
    
    messages = db.get_session_messages(session_id)
    
    user_messages = [m for m in messages if m.role == 'user']
    assistant_messages = [m for m in messages if m.role == 'assistant']
    
    total_tokens = sum(m.tokens_used or 0 for m in messages)
    
    duration = None
    if len(messages) > 1:
        duration = (messages[-1].timestamp - messages[0].timestamp).total_seconds()
    
    return {
        'total_messages': len(messages),
        'user_messages_count': len(user_messages),
        'assistant_messages_count': len(assistant_messages),
        'total_tokens': total_tokens,
        'duration_seconds': duration,
        'first_message': messages[0].timestamp if messages else None,
        'last_message': messages[-1].timestamp if messages else None
    }

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
analytics = get_session_analytics(session_id=1)
print(f"–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {analytics['total_messages']}")
print(f"–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {analytics['duration_seconds']} —Å–µ–∫")
print(f"–¢–æ–∫–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {analytics['total_tokens']}")
```

### –ü—Ä–∏–º–µ—Ä 4: –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞

```python
def export_chat_history(session_id, format='text'):
    """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞"""
    
    messages = db.get_session_messages(session_id)
    
    if format == 'text':
        lines = []
        for msg in messages:
            timestamp = msg.timestamp.strftime('%Y-%m-%d %H:%M:%S')
            role_emoji = 'üë§' if msg.role == 'user' else 'ü§ñ'
            lines.append(f"[{timestamp}] {role_emoji} {msg.role}: {msg.content}")
        return '\n'.join(lines)
    
    elif format == 'json':
        import json
        data = [{
            'timestamp': msg.timestamp.isoformat(),
            'role': msg.role,
            'content': msg.content,
            'tokens_used': msg.tokens_used
        } for msg in messages]
        return json.dumps(data, ensure_ascii=False, indent=2)
    
    elif format == 'html':
        html_lines = ['<div class="chat-history">']
        for msg in messages:
            css_class = 'user-message' if msg.role == 'user' else 'bot-message'
            html_lines.append(
                f'<div class="{css_class}">'
                f'<span class="timestamp">{msg.timestamp}</span>'
                f'<span class="content">{msg.content}</span>'
                f'</div>'
            )
        html_lines.append('</div>')
        return '\n'.join(html_lines)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
text_export = export_chat_history(1, 'text')
print(text_export)
```

### –ü—Ä–∏–º–µ—Ä 5: –ú–∏–≥—Ä–∞—Ü–∏—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
def convert_visitor_to_user(visitor_id, username, email, phone=None):
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –≤ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    # –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_id = db.create_user(username, email, phone)
    
    # –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å–µ —Å–µ—Å—Å–∏–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    from db.db import Session as DBSession
    session_obj = db.get_session()
    
    sessions = session_obj.query(DBSession).filter(
        DBSession.visitor_id == visitor_id
    ).all()
    
    for chat_session in sessions:
        chat_session.user_id = user_id
        # –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å visitor_id –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å
        # chat_session.visitor_id = None
    
    session_obj.commit()
    session_obj.close()
    
    return user_id

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
user_id = convert_visitor_to_user(
    visitor_id=1,
    username="john_doe",
    email="john@example.com",
    phone="+79001234567"
)
print(f"–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID: {user_id}")
```

---

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```python
try:
    user_id = db.create_user("john", "john@example.com")
except Exception as e:
    if "UNIQUE constraint failed" in str(e):
        print("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
    else:
        print(f"–û—à–∏–±–∫–∞: {e}")
```

### 2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

–í—Å–µ –º–µ—Ç–æ–¥—ã Database –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç rollback.

### 3. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

```python
# ‚ùå –ü–ª–æ—Ö–æ - –º–Ω–æ–≥–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
for i in range(100):
    db.add_knowledge(f"Question {i}", f"Answer {i}")

# ‚úÖ –•–æ—Ä–æ—à–æ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ batch –æ–ø–µ—Ä–∞—Ü–∏–∏
faq_list = [
    {'question': f"Question {i}", 'answer': f"Answer {i}"}
    for i in range(100)
]
for faq in faq_list:
    db.add_knowledge(**faq)
```

### 4. –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

–ú–µ—Ç–æ–¥—ã Database –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç —Å–µ—Å—Å–∏–∏ –≤ –±–ª–æ–∫–µ `finally`.

---

## SQL –∑–∞–ø—Ä–æ—Å—ã (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)

–ï—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

```python
from db.db import Visitor, Session as DBSession, Message

# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
session = db.get_session()
active_sessions = session.query(DBSession).filter(
    DBSession.is_active == True
).all()

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º FAQ
from sqlalchemy import func
stats = session.query(
    KnowledgeBase.category,
    func.count(KnowledgeBase.id).label('count')
).group_by(KnowledgeBase.category).all()

for category, count in stats:
    print(f"{category}: {count} –≤–æ–ø—Ä–æ—Å–æ–≤")

session.close()
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [SQLAlchemy –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://docs.sqlalchemy.org/)
- [PostgreSQL –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://www.postgresql.org/docs/)
- [README_DOCKER.md](README_DOCKER.md) - –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker

---

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã, —Å–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.
